<!doctype html>
<html>
     <head>
          <meta charset="utf-8">
          <title>Neighborhood Map</title>

          <style>

               #actionPane {
                    height: 100%;
                    width: 22%;
                    background-color: blanchedalmond;
                    position: absolute;
               }

               #header {
                    font-weight: bold;
                    text-align: center;
               }

               .paneTogglerRight {
                    color: cornsilk;
                    text-align: center;
                    height: 100%;
                    width: 2%;
                    background-color: chocolate;
                    position: absolute;
                    left: 22%;
               }

               .paneTogglerLeft {
                    color: cornsilk;
                    text-align: center;
                    height: 100%;
                    width: 2%;
                    background-color: chocolate;
                    position: absolute;
               }



               #map {
                  bottom:0px;
                  height: 100%;
                  position: absolute;
                  right: 0px;
               }
               .rightMap {
                  left: 24%;
               }
               .fullMap {
                  left: 3%;
               }

          </style>

     </head>
     <body>

          <div id="actionPane">
               <div id="header">Neighborhood Map (w Model)</div>
               <ul data-bind="foreach: placeList">
                    <li data-bind="text: name" ></li>
               </ul>
          </div>
          <div id="paneToggler" class="paneTogglerRight"><<</div>

          <div id="map" class="rightMap"></div>

          <script src="js/lib/knockout-3.2.0.js"></script>

          <script>

// TO DO 1/14/18:
// a) convert to formal MVVM
// b) add a filter to the pane.
// c) activate filter functionality
// d) consider rewriting reused code.

          //var markers = [];

            // // // // MODEL // // // // // // // // // // // // // // // // // // // // // // // //
            var model = {
            map,
            markers: [],
            places: [
                { name: 'Modern',
                  location: {lat: 41.313897 , lng: -72.913342 },
                  desc: 'The BEST PIZZA EVER!',
                  category: 'Food',
                  isFavorite: true
                },
                {
                   name: 'Himalaya',
                   location: {lat: 41.6277582, lng: -72.7570101},
                   desc: 'Good Indian Food',
                   category: 'Food'  ,
                   isFavorite: false
                },
                {
                   name: 'Chauncey Peak',
                   location: {lat: 41.5574852, lng: -72.7591303},
                   desc: 'Moderate hike with quick view of New Haven and Hartford',
                   category: 'Hiking',
                   isFavorite: false
                },
                {
                   name: 'West Hartford Reservoir',
                   location: {lat: 41.7523814, lng: -72.7890223},
                   desc: 'Mountain biking for all skill levels.',
                   category: 'Biking',
                   isFavorite: false
                },
                {
                   name: 'Rails to Trails Entrance',
                   location: {lat: 41.7702602, lng: -72.8486968},
                   desc: 'Paved walkway for leisurely hiking and biking.',
                   category: 'Biking',
                   isFavorite: false
                }
               ]
            };


            // // // // VIEW-MODEL // // // // // // // // // // // // // // // // // // // // // // // //
            var viewmodel = {
               getPlaces: function () {
                    return model.places;
               },

               getMap: function () {
                    return model.map;
               },

               /* IT SEEMS THIS ISN'T USED ANYWAY.
               getMarkers: function () {
                    return model.markers[];
               },
               */

               addMarker: function (marker) {
                    model.markers.push(marker);
               }

            };





               function initializeMap() {

                    var map =  viewmodel.getMap();

                    map = new google.maps.Map(document.getElementById('map'), {
                         center: {lat: 41.6102538, lng: -72.8219422},
                         zoom: 13,
                         mapTypeControl: false
                    });

                    var placeInfoWindow = new google.maps.InfoWindow();
/*
                    var defaultIcon = makeMarkerIcon('0091ff');
                    var favIcon     = makeMarkerIcon('FFFF24');
*/
                    var mImageDflt    = makeIcon('99AACC', 21, 34, 21, 34);
                    var mImageFav     = makeIcon('CCCC33', 21, 34, 21, 34);
                    var mImageDfltSel = makeIcon('99AACC', 21, 34, 21, 34);
                    var mImageFavSel  = makeIcon('CCCC33', 21, 34, 21, 34);
                    var mapBounds = new google.maps.LatLngBounds();

                    var thePlaces = viewmodel.getPlaces();

                    for (var i = 0; i < thePlaces.length; i++) {
                         var loc  = thePlaces[i].location;
                         var name = thePlaces[i].name;
                         var useIcon = mImageDflt;
                         if (thePlaces[i].isFavorite){
                              useIcon = mImageFav;
                         }
                         var marker = new google.maps.Marker({
                              map: map,
                              position: loc,
                              title: name,
                              animation: google.maps.Animation.DROP,
                              icon: useIcon,
                              id: i
                         });
                         mapBounds.extend(marker.position);

                         // anticipate and respond to click event
                         marker.addListener('click', function(){
                              populateInfoWindow(this, placeInfoWindow);
                         });


                    }
                    // i don't see how i could write them differently,
                    // BUT NOTE THAT this is inspired from Udacity examples.
                    // replaces by mvvm -
                    // markers.push(marker);

                    // alert('GOT HERE 1');
                    // var theMarkers = model.markers;
                    viewmodel.addMarker(marker);

                    // theMarkers.push(marker);
                    //alert('GOT HERE 2');

// move this after finishing marker code...
                    map.fitBounds(mapBounds);
                    /*
                    marker.addListener('click', function(){

                    }
                    */


                    // **** NOTE *** I THINK THE RUBRIC SAYS TO USE KNOCKOUT...(because it changes state?) CHANGE THIS:
                    document.getElementById('paneToggler').addEventListener('click', function () {
                         toggleActionPane();
                    });

                    // **** NOTE *** I THINK RUBRIC SAYS TO USE KNOCKOUT...(because it changes state?) CHANGE THIS:
                    document.getElementById('paneToggler').innerHTML = getTogBarChars('<');

               }


               // populateInfoWindow slightly modified from UDACITY examples. i changed to MVVM.
               // getStreetView functions taken from UDACITY examples.
               // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
               // This function populates the infowindow when the marker is clicked. We'll only allow
               // one infowindow which will open at the marker that is clicked, and populate based
               // on that markers position.
               function populateInfoWindow(marker, infowindow) {
                    // Check to make sure the infowindow is not already opened on this marker.
                    if (infowindow.marker != marker) {
                         // Clear the infowindow content to give the streetview time to load.
                         infowindow.setContent('');
                         infowindow.marker = marker;
                         // Make sure the marker property is cleared if the infowindow is closed.
                         infowindow.addListener('closeclick', function() {
                           infowindow.marker = null;
                         });

/************/
                         var streetViewService = new google.maps.StreetViewService();
                         var radius = 50;
                         // In case the status is OK, which means the pano was found, compute the
                         // position of the streetview image, then calculate the heading, then get a
                         // panorama from that and set the options
                         function getStreetView(data, status) {
                           if (status == google.maps.StreetViewStatus.OK) {
                             var nearStreetViewLocation = data.location.latLng;
                             //var heading = google.maps.geometry.spherical.computeHeading(
                             //              nearStreetViewLocation, marker.position);
                             var heading = 0;

                              infowindow.setContent('<div>V=Markers4' + marker.title + '</div><div id="pano"></div>');
                              var panoramaOptions = {
                                  position: nearStreetViewLocation,
                                  pov: {
                                      heading: heading,
                                      pitch: 30
                                  }
                              };
                             var panorama = new google.maps.StreetViewPanorama(
                                            document.getElementById('pano'), panoramaOptions);
                           } else {
                             infowindow.setContent('<div>' + marker.title + '</div>' +
                               '<div>No Street View Found</div>');
                           }
                         }
                         // Use streetview service to get the closest streetview image within
                         // 50 meters of the markers position
                         streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);
/**************/

                         // Open the infowindow on the correct marker.
                         var thisMap = viewmodel.getMap();
                         infowindow.open(thisMap, marker);
                    }
               }




                // makeIcon function is a modified copy of makeMarkerIcon function taken from UDACITY ud864 project sample:
                // Project_Code_5_BeingStylish.html
                // found here:  ***TODO ADD THE LINK TO THE GITHUB REPOSITORY *** *** *** ***
               // i took the ICON URL and default sizes from the UDACITY example.
               // https://developers.google.com/maps/documentation/javascript/3.exp/reference#Icon
               function makeIcon (markerColor, useWidth, useHeight, scaledWidth, scaledHeight) {
                    var icon = {
                         url: 'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|' + markerColor + '|40|_|%E2%80%A2',
                         size: new google.maps.Size(useWidth, useHeight),
                         origin: new google.maps.Point(0, 0),
                         anchor: new google.maps.Point(10,34),
                         scaledSize: new google.maps.Size(scaledWidth, scaledHeight)
                    };
                    return icon;
               }


               // **** NOTE *** RUBRIC SAYS TO USE KNOCKOUT... CHANGE THIS:
               function toggleActionPane () {
                    // toggle visibility of the action pane and resize the map
                    var actionPane = document.getElementById('actionPane');
                    var toggleBar = document.getElementById('paneToggler');
                    var map = document.getElementById('map');
                    if (actionPane.hidden) {
                         actionPane.hidden = false;
                         toggleBar.innerHTML = getTogBarChars('<'); // '<<';
                         toggleBar.className = 'paneTogglerRight';
                         map.className = "rightMap";
                    } else {
                         actionPane.hidden = true;
                         toggleBar.innerHTML = getTogBarChars('>'); // '>>';
                         toggleBar.className = 'paneTogglerLeft';
                         map.className = "fullMap";
                   }
               }

               // **** NOTE *** RUBRIC SAYS TO USE KNOCKOUT... CHANGE THIS:
               function getTogBarChars (direction) {
                    var useChar = '<';
                    var retChar = '';
                    if (direction == '>'){
                         useChar = '>';
                    }
                    for (i=0; i < 20; i++){
                         retChar = retChar + '<br>' + useChar;
                    }
                    return retChar;
               }

               // ===============================================================================

            var Place = function (data) {
               this.name       = ko.observable(data.name);
               this.location   = ko.observable(data.location);
               this.desc       = ko.observable(data.desc);
               this.category   = ko.observable(data.category);
               this.isFavorite = ko.observable(data.isFavorite);
            }

            var ViewModel = function () {
                var self = this;

                this.placeList = ko.observableArray([]);
                thePlaces = viewmodel.getPlaces();
                thePlaces.forEach(function(individualPlace){
                    self.placeList.push(new Place(individualPlace));
                });

            }

            ko.applyBindings(new ViewModel());

          </script>

          <script async defer
               src="https://maps.googleapis.com/maps/api/js?libraries=geometry,drawing&key=AIzaSyDCiCbk_jLIFqlH2s1gmzdIehfkP7JkTVU&v=3&callback=initializeMap">
          </script>


     </body>
</html>
