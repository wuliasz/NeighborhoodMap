<!doctype html>
<html>
     <head>
          <meta charset="utf-8">
          <title>Neighborhood Map</title>

          <style>

               #actionPane {
                    height: 100%;
                    width: 22%;
                    background-color: blanchedalmond;
                    position: absolute;
               }

               #header {
                    font-family: Arial;
                    color: cadetblue;
                    font-weight: bold;
                    text-align: center;
               }

               #separator {
                    height: 100%;
                    width: 1%;
                    background-color: cornsilk;
                    position: absolute;
                    left: 22%;
               }

               .placeList {
                    font-family: Arial;
                    font-size: smaller;
                    color: cadetblue;
                    font-weight: bold;
                    padding-top: 0.5em;
                    list-style-type: none;
                }

               .placeListHighlight {
                    font-family: Arial;
                    color: cadetblue;
                    font-weight: bold;
                    font-size: larger;
                    padding-top: 0.5em;
               }

               #map {
                  bottom:0px;
                  height: 100%;
                  position: absolute;
                  right: 0px;
               }
               .rightMap {
                  left: 23%;
               }
               .fullMap {
                  left: 3%;
               }

          </style>

     </head>
     <body>

          <div id="actionPane">
               <div id="header">Neighborhood Map (18-1-15-22-00)</div>
               <ul data-bind="foreach: placeList">
                    <li data-bind="click: $parent.highlightLoc, text: name" class="placeList" id="placeListItem"></li>
               </ul>
          </div>
          <div id="separator">&nbsp;</div>

          <div id="map" class="rightMap"></div>

          <script src="js/lib/knockout-3.2.0.js"></script>

          <script>

// TO DO 1/14/18:
// a) convert to formal MVVM
// b) add a filter to the pane.
// c) activate filter functionality
// d) consider rewriting reused code.

            /// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
            // // // // MODEL // // // // // // // // // // // // // // // // // // // // // // // // // ///
            var model = {
            map,
            markers: [],
            places: [
                { name: 'Modern',
                  location: {lat: 41.313897 , lng: -72.913342 },
                  desc: 'The BEST PIZZA EVER!',
                  category: 'Food',
                  isFavorite: true
                },
                {
                   name: 'Himalaya',
                   location: {lat: 41.6277582, lng: -72.7570101},
                   desc: 'Good Indian Food',
                   category: 'Food'  ,
                   isFavorite: false
                },
                {
                   name: 'Chauncey Peak',
                   location: {lat: 41.5574852, lng: -72.7591303},
                   desc: 'Moderate hike with quick view of New Haven and Hartford',
                   category: 'Hiking',
                   isFavorite: false
                },
                {
                   name: 'West Hartford Reservoir',
                   location: {lat: 41.7523814, lng: -72.7890223},
                   desc: 'Mountain biking for all skill levels.',
                   category: 'Biking',
                   isFavorite: false
                },
                {
                   name: 'Rails to Trails Entrance',
                   location: {lat: 41.7702602, lng: -72.8486968},
                   desc: 'Paved walkway for leisurely hiking and biking.',
                   category: 'Biking',
                   isFavorite: false
                }
               ],

               // map styles from taken from:  https://snazzymaps.com/style/61/blue-essence
               mapStyles: [
                            {
                                "featureType": "landscape.natural",
                                "elementType": "geometry.fill",
                                "stylers": [
                                    {
                                        "visibility": "on"
                                    },
                                    {
                                        "color": "#e0efef"
                                    }
                                ]
                            },
                            {
                                "featureType": "poi",
                                "elementType": "geometry.fill",
                                "stylers": [
                                    {
                                        "visibility": "on"
                                    },
                                    {
                                        "hue": "#1900ff"
                                    },
                                    {
                                        "color": "#c0e8e8"
                                    }
                                ]
                            },
                            {
                                "featureType": "road",
                                "elementType": "geometry",
                                "stylers": [
                                    {
                                        "lightness": 100
                                    },
                                    {
                                        "visibility": "simplified"
                                    }
                                ]
                            },
                            {
                                "featureType": "road",
                                "elementType": "labels",
                                "stylers": [
                                    {
                                        "visibility": "off"
                                    }
                                ]
                            },
                            {
                                "featureType": "transit.line",
                                "elementType": "geometry",
                                "stylers": [
                                    {
                                        "visibility": "on"
                                    },
                                    {
                                        "lightness": 700
                                    }
                                ]
                            },
                            {
                                "featureType": "water",
                                "elementType": "all",
                                "stylers": [
                                    {
                                        "color": "#7dcdcd"
                                    }
                                ]
                            }
                        ]

            };


            /// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
            // // // // VIEW-MODEL  // // // // // // // // // // // // // // // // // // // // // // // ///
            var viewmodel = {

               init: function() {
                    //view.init();
                    ko.applyBindings(new view.init());
               },

               getPlaces: function () {
                    return model.places;
               },

               getMap: function () {
                    return model.map;
               },

               getMapStyles: function () {
                    return model.mapStyles;
               },

               /* IT SEEMS THIS ISN'T USED ANYWAY.
               getMarkers: function () {
                    return model.markers[];
               },
               */

               addMarker: function (marker) {
                    model.markers.push(marker);
               },

               initializeMap: function () {

                    var map       =  viewmodel.getMap();
                    var useStyles =  viewmodel.getMapStyles();

                    map = new google.maps.Map(document.getElementById('map'), {
                         center: {lat: 41.6102538, lng: -72.8219422},
                         styles: useStyles,
                         zoom: 13,
                         mapTypeControl: false
                    });

                    var placeInfoWindow = new google.maps.InfoWindow();

                    // ICON SIZES (21, 34) TAKEN FROM UDACITY EXAMPLES
                    var mImageDflt    = viewmodel.makeIcon('99AACC', 21, 34, 21, 34);
                    var mImageFav     = viewmodel.makeIcon('CCCC33', 21, 34, 21, 34);
                    var mImageDfltSel = viewmodel.makeIcon('99AACC', 21, 34, 21, 34);
                    var mImageFavSel  = viewmodel.makeIcon('CCCC33', 21, 34, 21, 34);
                    var mapBounds = new google.maps.LatLngBounds();

                    var thePlaces = viewmodel.getPlaces();

                    for (var i = 0; i < thePlaces.length; i++) {
                         var loc  = thePlaces[i].location;
                         var name = thePlaces[i].name;
                         var useIcon = mImageDflt;
                         if (thePlaces[i].isFavorite){
                              useIcon = mImageFav;
                         }
                         var marker = new google.maps.Marker({
                              map: map,
                              position: loc,
                              title: name,
                              animation: google.maps.Animation.DROP,
                              icon: useIcon,
                              id: i
                         });
                         mapBounds.extend(marker.position);

                         // anticipate and respond to click event
                         marker.addListener('click', function(){
                              viewmodel.populateInfoWindow(this, placeInfoWindow);
                         });


                    }
                    viewmodel.addMarker(marker);
                    map.fitBounds(mapBounds);
                    /*
                    marker.addListener('click', function(){

                    }
                    */

               },


               // populateInfoWindow slightly modified from UDACITY examples. i changed to MVVM.
               // getStreetView functions taken from UDACITY examples.
               // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
               // This function populates the infowindow when the marker is clicked. We'll only allow
               // one infowindow which will open at the marker that is clicked, and populate based
               // on that markers position.
               populateInfoWindow: function (marker, infowindow) {
                    // Check to make sure the infowindow is not already opened on this marker.
                    if (infowindow.marker != marker) {
                         // Clear the infowindow content to give the streetview time to load.
                         infowindow.setContent('');
                         infowindow.marker = marker;
                         // Make sure the marker property is cleared if the infowindow is closed.
                         infowindow.addListener('closeclick', function() {
                           infowindow.marker = null;
                         });

/************/
                         var streetViewService = new google.maps.StreetViewService();
                         var radius = 50;
                         // In case the status is OK, which means the pano was found, compute the
                         // position of the streetview image, then calculate the heading, then get a
                         // panorama from that and set the options
                         function getStreetView(data, status) {
                           if (status == google.maps.StreetViewStatus.OK) {
                             var nearStreetViewLocation = data.location.latLng;
                             var heading = google.maps.geometry.spherical.computeHeading(
                                           nearStreetViewLocation, marker.position);
                              infowindow.setContent('<div>V=Markers4' + marker.title + '</div><div id="pano"></div>');
                              var panoramaOptions = {
                                  position: nearStreetViewLocation,
                                  pov: {
                                      heading: heading,
                                      pitch: 30
                                  }
                              };
                             var panorama = new google.maps.StreetViewPanorama(
                                            document.getElementById('pano'), panoramaOptions);
                           } else {
                             infowindow.setContent('<div>' + marker.title + '</div>' +
                               '<div>No Street View Found</div>');
                           }
                         }
                         // Use streetview service to get the closest streetview image within
                         // 50 meters of the markers position
                         streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);
/**************/

                         // Open the infowindow on the correct marker.
                         var thisMap = viewmodel.getMap();
                         infowindow.open(thisMap, marker);
                    }
               },



                // makeIcon function is a modified copy of makeMarkerIcon function taken from UDACITY ud864 project sample:
                // Project_Code_5_BeingStylish.html
                // found here:  ***TODO ADD THE LINK TO THE GITHUB REPOSITORY *** *** *** ***
               // i took the ICON URL and default sizes from the UDACITY example.
               // https://developers.google.com/maps/documentation/javascript/3.exp/reference#Icon
               makeIcon: function (markerColor, useWidth, useHeight, scaledWidth, scaledHeight) {
                    var icon = {
                         url: 'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|' + markerColor + '|40|_|%E2%80%A2',
                         size: new google.maps.Size(useWidth, useHeight),
                         origin: new google.maps.Point(0, 0),
                         anchor: new google.maps.Point(10,34),
                         scaledSize: new google.maps.Size(scaledWidth, scaledHeight)
                    };
                    return icon;
               }

            };



            /// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
            // // // // VIEW  // // // // // // // // // // // // // // // // // // // // // // // // // ///
            var view = {

                Place: function (data) {
                    this.name       = ko.observable(data.name);
                    this.location   = ko.observable(data.location);
                    this.desc       = ko.observable(data.desc);
                    this.category   = ko.observable(data.category);
                    this.isFavorite = ko.observable(data.isFavorite);
                },

                init: function() {
                // here in init we set up connections between KO and the DOM
                // and define listeners... etc.

                    var self = this;

                    // NOTE: IMPLICIT placeList DECLARATION WITH view LEVEL SCOPE
                    //       its the only way i could get it to work.
                    placeList = ko.observableArray([]);

                    this.placeListItem = document.getElementById('placeListItem');
                    this.highlightLoc = function () {
                                alert('highlight ');
                    };

                    view.render();

                },

                render: function() {
                // here in render, we'll display the page
                // adjusting to line up with changes from recent events

// now i'm changing this to dynamically build the list.
// IN ORDER TO ADD LISTENERS?
//               <ul data-bind="foreach: placeList">
//                    <li data-bind="text: name" class="placeList" id="placeListItem"></li>
//               </ul>


                     var thePlaces = viewmodel.getPlaces();
                     thePlaces.forEach(function(individualPlace){
                         placeList.push(new view.Place(individualPlace));
                    });

               },



               // it didn't work here.   yes, i had the comma at the prior }
               //highlightLoc: function () {
               //     alert('hightlight me!');
               //}

            };


            viewmodel.init();

          </script>

          <script async defer
               src="https://maps.googleapis.com/maps/api/js?libraries=geometry,drawing&key=AIzaSyDCiCbk_jLIFqlH2s1gmzdIehfkP7JkTVU&v=3&callback=viewmodel.initializeMap">
          </script>


     </body>
</html>
