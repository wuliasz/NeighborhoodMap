<!doctype html>
<html>
     <head>
          <meta charset="utf-8">
          <title>Neighborhood Map</title>

          <style>

               #actionPane {
                    height: 100%;
                    width: 22%;
                    min-width: 200px;
                    background-color: blanchedalmond;
                    position: absolute;
               }

               #header {
                    font-family: Arial;
                    color: cadetblue;
                    font-weight: bold;
                    text-align: center;
               }

               #separator {
                    height: 100%;
                    width: 1%;
                    background-color: cornsilk;
                    position: absolute;
                    left: 22%;
               }

               .placeList {
                    font-family: Arial;
                    font-size: smaller;
                    color: cadetblue;
                    font-weight: bold;
                    padding-top: 1em;
                    list-style-type: none;
                }

               .placeListHighlight {
                    font-family: Arial;
                    font-size: larger;
                    color: cadetblue;
                    font-weight: bold;
                    padding-top: 0.5em;
               }

               #selDesc {
                    position: absolute;
                    top: 60%;
                    font-family: Arial;
                    color: darkblue;
                    width: 90%;
               }


               #filter {
                    position: absolute;
                    top: 90%;
                    color: cadetblue;
               }

               #map {
                  bottom:0px;
                  height: 100%;
                  position: absolute;
                  right: 0px;
               }
               .rightMap {
                  left: 23%;
               }
               .fullMap {
                  left: 3%;
               }

          </style>

     </head>
     <body>

          <div id="actionPane">
               <div id="header">Neighborhood Map (W)</div>


                <div class="wikipedia-container">
                    <h3 id="wikipedia-header" data-bind="text: wikiHeader"></h3>
                    <div id="wikipedia-links" data-bind="foreach: wikiList">


<!------ THE ONLY TIME KNOCKOUT EVER GIVES ME OUTPUT IS IF I BIND "text: $data"
        IF ANYTHING ELSE IS USED... THIS LINE IS COMPLETELY OMITTED
        WHEN IT IS OMITTED, NO DEV TOOLS ERRORS ARE RECOGNIZED.
        THE COUNT DISPLAYED IN THE HEADER ALWAYS SHOWS THAT THERE 'ARE' RECORDS RETURNED

        text: name doesn't work
        text: descr doesn't work - i changed descr

        ------>
                        <span data-bind="text: $data" id="wikiItem"></span>
                    </div>
                </div>


               <!---- NOTE: NEXT TWO DIVS WERE UL/LI BUT THESE MIGHT FORMAT BETTER ---->
               <div data-bind="foreach: placeList">
                    <div data-bind="click: $parent.highlightLoc.bind($data, $index()),
                                    text: name,
                                    attr: { class: itemclass }"
                         zclass="placeList"
                         id="placeListItem">
                    </div>
               </div>
               <span id="selDesc" data-bind="text: selectedDescription"></div>


               <div id="filter">
                   <div id="catFilterLabel">Filter by Category:
                   <select id="categorySelect" data-bind="options: filterTypes,
                                                          value: selectedCategory,
                                                          event: {change: applyFilters}">
                   </select>
                   <!------
                    <div data-bind="visible: selectedCategory">
                        Viewing Category:
                        <span id="selectedCategory" data-bind="text: selectedCategory "></span>
                    </div>
                    ------>
                </div>
            </div>
          <div id="separator">&nbsp;</div>

          <div id="map" class="rightMap"></div>

          <script src="js/libs/jquery.min.js"></script>
          <script src="js/libs/knockout-3.2.0.js"></script>


          <script>

// TO DO 1/16/18:
// v a) convert to formal MVVM
// v b) add a filter to the pane.
// v c) activate filter functionality
// x d) consider rewriting reused code.
// v e) activate highlighting -
//      when selecting from list or marker:
//      highlight the other;  show additional info
//   f) add 3rd party api something.  such as: wikipedia, nt times, fourscquare
//      add it to the info window.
//   g) complete styling.

            /// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
            // // // // MODEL // // // // // // // // // // // // // // // // // // // // // // // // // ///
            var model = {
            map,
            markers: [],
            places: [
                { name: 'Modern',
                  location: {lat: 41.313897 , lng: -72.913342 },
                  desc: 'The BEST PIZZA EVER!',
                  category: 'Food',
                  isFavorite: true
                },
                {
                   name: 'Himalaya',
                   location: {lat: 41.6277582, lng: -72.7570101},
                   desc: 'Good Indian Food',
                   category: 'Food'  ,
                   isFavorite: false
                },
                {
                   name: 'Chauncey Peak',
                   location: {lat: 41.5574852, lng: -72.7591303},
                   desc: 'Moderate hike with quick view of New Haven and Hartford',
                   category: 'Hiking',
                   isFavorite: false
                },
                {
                   name: 'West Hartford Reservoir',
                   location: {lat: 41.7523814, lng: -72.7890223},
                   desc: 'Mountain biking for all skill levels.',
                   category: 'Biking',
                   isFavorite: false
                },
                {
                   name: 'Rails to Trails Entrance',
                   location: {lat: 41.7702602, lng: -72.8486968},
                   desc: 'Paved walkway for leisurely hiking and biking.',
                   category: 'Biking, Hiking',
                   isFavorite: false
                }
               ],

               // map styles from taken from:  https://snazzymaps.com/style/61/blue-essence
               mapStyles: [
                            {
                                "featureType": "landscape.natural",
                                "elementType": "geometry.fill",
                                "stylers": [
                                    {
                                        "visibility": "on"
                                    },
                                    {
                                        "color": "#e0efef"
                                    }
                                ]
                            },
                            {
                                "featureType": "poi",
                                "elementType": "geometry.fill",
                                "stylers": [
                                    {
                                        "visibility": "on"
                                    },
                                    {
                                        "hue": "#1900ff"
                                    },
                                    {
                                        "color": "#c0e8e8"
                                    }
                                ]
                            },
                            {
                                "featureType": "road",
                                "elementType": "geometry",
                                "stylers": [
                                    {
                                        "lightness": 100
                                    },
                                    {
                                        "visibility": "simplified"
                                    }
                                ]
                            },
                            {
                                "featureType": "road",
                                "elementType": "labels",
                                "stylers": [
                                    {
                                        "visibility": "off"
                                    }
                                ]
                            },
                            {
                                "featureType": "transit.line",
                                "elementType": "geometry",
                                "stylers": [
                                    {
                                        "visibility": "on"
                                    },
                                    {
                                        "lightness": 700
                                    }
                                ]
                            },
                            {
                                "featureType": "water",
                                "elementType": "all",
                                "stylers": [
                                    {
                                        "color": "#7dcdcd"
                                    }
                                ]
                            }
                        ]

            };


            /// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
            // // // // VIEW-MODEL  // // // // // // // // // // // // // // // // // // // // // // // ///
            var viewmodel = {

               init: function() {
                    //view.init();
                    ko.applyBindings(new view.init());
               },

               getPlaces: function () {
                    return model.places;
               },

               getPlace: function (atIndex) {
                    return model.places[atIndex];
               },

               getMap: function () {
                    return model.map;
               },

               getMapStyles: function () {
                    return model.mapStyles;
               },

               getMarkers: function () {
                    return model.markers;
               },

               getMarker: function (atIndex) {
                    return model.markers[atIndex];
               },

               addMarker: function (marker) {
                    model.markers.push(marker);
               },

               initializeMap: function () {

                    var map       =  viewmodel.getMap();
                    var useStyles =  viewmodel.getMapStyles();

                    map = new google.maps.Map(document.getElementById('map'), {
                         center: {lat: 41.6102538, lng: -72.8219422},
                         styles: useStyles,
                         zoom: 13,
                         mapTypeControl: false
                    });

//18
//                    var placeInfoWindow = new google.maps.InfoWindow();
//18                var placeInfoWindow = getInfoWindow();
                    var theInfoWindow = viewmodel.placeInfoWindow();

                    // ICON SIZES (21, 34) TAKEN FROM UDACITY EXAMPLES
                    var mImageDflt    = viewmodel.makeIcon('99AACC', 21, 34, 21, 34);
                    var mImageFav     = viewmodel.makeIcon('CCCC33', 21, 34, 21, 34);
                    var mImageDfltSel = viewmodel.makeIcon('99AACC', 26, 41, 26, 41);
                    var mImageFavSel  = viewmodel.makeIcon('CCCC33', 26, 41, 26, 41);
                    var mapBounds = new google.maps.LatLngBounds();

                    var thePlaces = viewmodel.getPlaces();

                    for (var i = 0; i < thePlaces.length; i++) {


                         var loc  = thePlaces[i].location;
                         var name = thePlaces[i].name;
                         var useIcon = mImageDflt;
                         if (thePlaces[i].isFavorite){
                              useIcon = mImageFav;
                         }

                         var marker = new google.maps.Marker({
                              map: map,
                              position: loc,
                              title: name,
                              animation: google.maps.Animation.DROP,
                              icon: useIcon,
                              id: i
                         });

                         mapBounds.extend(marker.position);

                         // anticipate and respond to click event
                         marker.addListener('click', function(){

// it says that the marker should animate when clicked...
// need additional location info

                              viewmodel.populateInfoWindow(this, theInfoWindow);

                         });
                        viewmodel.addMarker(marker);



                    }
                    map.fitBounds(mapBounds);

               },


               placeInfoWindow: function () {
                    var returnInfoWindow;
                    if (!(this instanceof google.maps.InfoWindow)) {
                        return new google.maps.InfoWindow();
                    } else {
                        return returnInfoWindow;
                    }
               },
/*
// 18
               getInfoWindow: function () {
                    return new google.maps.InfoWindow();
               },
*/

               // populateInfoWindow slightly modified from UDACITY examples. i changed to MVVM.
               // getStreetView functions taken from UDACITY examples.
               // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
               // This function populates the infowindow when the marker is clicked. We'll only allow
               // one infowindow which will open at the marker that is clicked, and populate based
               // on that markers position.
               populateInfoWindow: function (marker, infowindow) {
                    // Check to make sure the infowindow is not already opened on this marker.
                    if (infowindow.marker != marker) {
                        // Clear the infowindow content to give the streetview time to load.
                        infowindow.setContent('');
                        infowindow.marker = marker;
                        // Make sure the marker property is cleared if the infowindow is closed.
                        infowindow.addListener('closeclick', function() {
                            infowindow.marker = null;
                        });

                        var thisPlace = viewmodel.getPlace(marker.id);
                        var useContent = '<div id="infowindowtitle">' + marker.title + '</div>';
                        useContent = useContent + '<div id="infowindow">' + thisPlace.desc + '</div>';
                        infowindow.setContent(useContent);
                        //function setInfoWindowContent () {
                        //if (status == google.maps.StreetViewStatus.OK) {

                        //   infowindow.setContent('<div>V=Markers4' + marker.title + '</div><div id="pano"></div>');

                        //} else {
                        //  infowindow.setContent('<div>' + marker.title + '</div>' +
                        //    '<div>No Street View Found</div>');
                        //}
                        //}

                        // Open the infowindow on the correct marker.
                        var thisMap = viewmodel.getMap();
                        infowindow.open(thisMap, marker);
                    }
               },



                // makeIcon function is a modified copy of
                // makeMarkerIcon function taken from UDACITY ud864 project sample:
                // Project_Code_5_BeingStylish.html
                // found here:  ***TODO ADD THE LINK TO THE GITHUB REPOSITORY *** *** *** ***
                // i took the ICON URL and default sizes from the UDACITY example.
                // https://developers.google.com/maps/documentation/javascript/3.exp/reference#Icon
                makeIcon: function (markerColor, useWidth, useHeight, scaledWidth, scaledHeight) {
                    var icon = {
                         url: 'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|' + markerColor + '|40|_|%E2%80%A2',
                         size: new google.maps.Size(useWidth, useHeight),
                         origin: new google.maps.Point(0, 0),
                         anchor: new google.maps.Point(10,34),
                         scaledSize: new google.maps.Size(scaledWidth, scaledHeight)
                    };
                    return icon;
                }

            };



            /// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
            // // // // VIEW  // // // // // // // // // // // // // // // // // // // // // // // // // ///
            var view = {

                Place: function (data) {
                    this.name       = ko.observable(data.name);
                    this.location   = ko.observable(data.location);
                    this.desc       = ko.observable(data.desc);
                    this.category   = ko.observable(data.category);
                    this.isFavorite = ko.observable(data.isFavorite);
                    this.itemclass  = ko.observable('placeList');
                },


                HighlightedPlace: function (data) {
                    this.name       = ko.observable(data.name);
                    this.location   = ko.observable(data.location);
                    this.desc       = ko.observable(data.desc);
                    this.category   = ko.observable(data.category);
                    this.isFavorite = ko.observable(data.isFavorite);
                    this.itemclass  = ko.observable('placeListHighlight');
                },

                WikiEntry: function (data) {
                    this.name = ko.observable(data.name);
                    this.url   = ko.observable(data.url);
                },

                init: function() {
                // here in init we set up connections between KO and the DOM
                // and define listeners... etc.

                    var self = this;

                    // NOTE: IMPLICIT DECLARATION WITH view LEVEL SCOPE
                    //       its the only way i could get it to work.
                    placeList           = ko.observableArray([]);
                    currentDescription  = ko.observable();
                    selectedDescription = ko.observable(document.getElementById('selDesc'));
                    selectedDescription('');
                    selectedIndex       = ko.observable();
            /* TOOK OFF THE this. FROM selectedCategory FOR THIS NEXT PHASE */
                    selectedCategory    = ko.observable(document.getElementById('selectedCategory'));
                    selectedCategory('All');
                    bounceIndex         = ko.observable(-1);


                    //wikiHeader          = ko.observable(document.getElementById('wikipedia-header'));
                    //wikiHeader('init');
                    wikiHeader          = ko.observable('header init');
                    wikiList            = ko.observableArray([]);


                    //this.placeListItem      = document.getElementById('placeListItem');
                    this.filterTypes        = ko.observableArray(['All','Food','Biking','Hiking']);
                    this.categorySelector   = ko.observableArray(document.getElementById('categorySelect'));

                    this.highlightLoc = function (index) {

                        selectedIndex(index);
                        bounceIndex(index);
                        view.getWikipedia();
                        view.render();

// SOOOO BIZARRE!!! THIS STATEMENT WOULD ABSOLUTELY NOT WORK USING ()
// implied to be a view.Place... is that the difference?
//                            var theCat = thePlace.category;

                    };

                    this.applyFilters = function () {
                        selectedIndex(-1);
                        bounceIndex(-1);
                        view.render();
                    };

                    view.render();
                },

                render: function() {
                    placeList.removeAll();
                    let thePlaces       = viewmodel.getPlaces();
                    let currentCategory = selectedCategory();
                    let currentIndex    = selectedIndex();
                    let thisIndex = -1;
                    let actualIndex = -1;
                    let thisPlace;

                    selectedDescription('');
                    let useDescription = '';
                    theMarkers = viewmodel.getMarkers();
                    let thisMarker;

                    // first try to reset every marker animation.
                    for (let i = 0; i < theMarkers.length; i++) {
                        thisMarker = theMarkers[i];
                        try {
                            thisMarker.setAnimation(null);
                        } catch (err) {
                            let x = true;
                        }
                    }


                    thePlaces.forEach(function(individualPlace){
                        thisPlace = new view.Place(individualPlace);
// SOOOO BIZARRE!!! THIS STATEMENT WOULD ABSOLUTELY NOT WORK WITHOUT USING ()
// although thisPlace was just instantiated, explicitly as a view.Place
// it it not explicitly declared as one.
                        //let thisCat = thisPlace.category();
                        categoryMatches = (thisPlace.category().indexOf(currentCategory) >= 0);

                        actualIndex++;
                        //let thisMarker = viewmodel.getMarker(actualIndex);
                        let thisMarker = theMarkers[actualIndex];

                        //if (currentCategory == 'All' || thisPlace.category() == currentCategory) {
                        if (currentCategory == 'All' || categoryMatches ) {
                            thisIndex++;
                            if (thisIndex == currentIndex) {
                                thisPlace = new view.HighlightedPlace(individualPlace);
                                selectedDescription(thisPlace.desc());
                            }
                            if (thisIndex == bounceIndex()) {
                                thisMarker.setAnimation(google.maps.Animation.BOUNCE);
                            }
                            placeList.push(thisPlace);
                        }
                    });
                },



                getWikipedia: function () {
                            /*
                     var wikiURL = 'https://en.wikipedia.org/w/api.php?action=opensearch&search=' + city + '&format=json&callback=wikiCallBack';
                            */

                    //$wikiElem = $('#wikipedia-links');

                    // clear out old data before new request
                    // $wikiElem.text("test 1");
                    //alert('getting 1');
                    wikiHeader('changed');
                    //self.wikiList('nanoo!');
                    //alert('getting 2');
                     var wikiURL = 'https://en.wikipedia.org/w/api.php?action=opensearch&search=hartford&format=json&callback=wikiCallBack';


                     var wikiRequestTimeout = setTimeout(function(){
                          wikiHeader('failed to get wikipedia resources');
                          wikiList("failed to get wikipedia resources");
                     }, 8000);

                    $.ajax({
                        url: wikiURL,
                        dataType: 'jsonp',
                        success: function (response){
                            pages = response[1];

                            wikiHeader('pages:  ' + pages.length);
                            wikiList.removeAll();
                            topLimit = pages.length;
                            if (topLimit > 5) {
                                topLimit = 5;
                            }
                            for (var i = 0; i < topLimit; i++) {
                                   var link = pages[i];
                                   var wUrl = 'http://en.wikipedia.org/wiki/' + link;
                                   /*
                                   wikiList.append('<li class="link">'+
                                        '<a href="' + wUrl + '" target="_blank">'
                                        + link + '</a>' + '</li>');
                                    */

                                  /* 1 22 18 15 58 works:
                                   wikiList.push('<a href="' + wUrl + '" target="_blank">'
                                        + link + '</a>');
                                    */
                                    wiStr = '{name: "' + link +'", url: "' + wUrl + '"}';
                                    thisEntry = new view.WikiEntry(wiStr);

                                    // if pushing a WikiEntry instance, the page only displays Object
                                    //wikiList.push(thisEntry);

                                    // is pushing the wiStr the page will diusplay the JSON,
                                    // but i can't access the individual elements
                                    // i followed ths JSON method from the knockout documentation.
                                    wikiList.push(wiStr);
                            };
                            clearTimeout(wikiRequestTimeout);
                        }
                    });
                }
            };

            viewmodel.init();

          </script>

          <script async defer
               src="https://maps.googleapis.com/maps/api/js?libraries=geometry,drawing&key=AIzaSyDCiCbk_jLIFqlH2s1gmzdIehfkP7JkTVU&v=3&callback=viewmodel.initializeMap">
          </script>
     </body>
</html>
